<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Partner view - Cycle status and supportive guidance.">
    <title>Partner View - Axion</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/animations.css">
</head>

<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <a href="../index.html" class="nav__logo">AXION</a>
            <ul class="nav__links">
                <li><a href="../index.html" class="nav__link">Home</a></li>
                <li><a href="dashboard.html" class="nav__link">Dashboard</a></li>
            </ul>
        </nav>

        <!-- Link Form (shown if not linked) -->
        <div id="link-form" class="status">
            <div class="status__header">
                <span class="status__brand">Partner Access</span>
            </div>

            <h2 style="margin-bottom: var(--space-4);">Connect with Partner</h2>
            <p>Enter the code shared by your partner to receive cycle status updates.</p>

            <form id="partner-link-form" style="margin-top: var(--space-6);">
                <div class="form-group">
                    <label class="form-label">Your Name</label>
                    <input type="text" name="name" class="form-input" placeholder="Enter your name" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Partner Code</label>
                    <input type="text" name="linkCode" class="form-input text-mono" placeholder="XXXXXX" maxlength="6"
                        required style="text-transform: uppercase; letter-spacing: 0.2em;">
                </div>

                <button type="submit" class="btn btn--primary" style="width: 100%; margin-top: var(--space-4);">
                    Connect
                </button>
            </form>
        </div>

        <!-- Partner Dashboard (shown when linked) -->
        <div id="partner-dashboard" style="display: none;">
            <div class="status">
                <div class="status__header">
                    <span class="status__brand">Axion</span>
                    <span class="status__day" id="day-display">Day -- of --</span>
                </div>

                <div class="status__phase">
                    <div class="status__phase-label">Current Phase</div>
                    <div class="status__phase-name" id="phase-name">Loading...</div>
                </div>

                <div class="status__message" id="status-message">
                    Loading status...
                </div>

                <div class="status__tip">
                    <div class="status__tip-label">Guidance</div>
                    <p id="status-tip">Loading...</p>
                </div>

                <div class="divider"></div>

                <div class="actions">
                    <button class="action-btn" onclick="showSuggestion('comfort')">Comfort</button>
                    <button class="action-btn" onclick="showSuggestion('date')">Date Ideas</button>
                    <button class="action-btn" onclick="showSuggestion('gift')">Gifts</button>
                </div>

                <div class="cycle-info">
                    <div class="cycle-info__item">
                        <div class="cycle-info__value" id="cycle-day">--</div>
                        <div class="cycle-info__label">Cycle Day</div>
                    </div>
                    <div class="cycle-info__item">
                        <div class="cycle-info__value" id="days-until">--</div>
                        <div class="cycle-info__label">Days Until Next</div>
                    </div>
                </div>

                <!-- Notification Setup -->
                <div class="notification-setup">
                    <h4>Desktop Notifications</h4>
                    <p id="notification-status">Receive daily status updates</p>
                    <div style="display: flex; gap: var(--space-3);">
                        <button class="btn btn--secondary" id="enable-notifications-btn"
                            onclick="enableNotifications()">
                            Enable
                        </button>
                        <button class="btn btn--ghost" id="test-notification-btn" onclick="testNotification()"
                            style="display: none;">
                            Test
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Axion - Cycle awareness system</p>
        </footer>
    </div>

    <!-- Scripts -->
    <script src="../js/cycle.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/notifications.js"></script>
    <script src="../js/desktop-notifications.js"></script>
    <script src="../js/app.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            checkPartnerAccess();
        });

        function checkPartnerAccess() {
            const partner = window.MoodSyncStorage.getPartnerProfile();
            const user = window.MoodSyncStorage.getUserProfile();

            if (user && user.lastPeriodDate) {
                showPartnerDashboard(partner?.name || 'Partner');
            } else if (partner && partner.linkCode) {
                showPartnerDashboard(partner.name);
            }
        }

        function showPartnerDashboard(name) {
            document.getElementById('link-form').style.display = 'none';
            document.getElementById('partner-dashboard').style.display = 'block';
            updatePartnerView();
        }

        function updatePartnerView() {
            const user = window.MoodSyncStorage.getUserProfile();

            if (!user || !user.lastPeriodDate) {
                document.getElementById('phase-name').textContent = 'No Data';
                document.getElementById('status-message').textContent = 'Link with your partner to receive cycle status updates.';
                document.getElementById('status-tip').textContent = 'Request the partner code from your partner.';
                return;
            }

            const cycleInfo = window.MoodSyncCycle.getCycleInfo(user.lastPeriodDate, user.cycleLength);
            const notification = window.MoodSyncCycle.getPartnerNotification(cycleInfo);

            // Update display
            document.getElementById('day-display').textContent = `Day ${cycleInfo.currentDay} of ${cycleInfo.cycleLength}`;
            document.getElementById('phase-name').textContent = notification.phase;
            document.getElementById('status-message').textContent = notification.message;
            document.getElementById('status-tip').textContent = notification.tip;
            document.getElementById('cycle-day').textContent = cycleInfo.currentDay;
            document.getElementById('days-until').textContent = cycleInfo.daysUntilNext;
        }

        function showSuggestion(type) {
            const suggestions = {
                comfort: {
                    title: 'Comfort Ideas',
                    items: [
                        'Prepare her preferred comfort food',
                        'Offer a heating pad or warm compress',
                        'Run a relaxing bath',
                        'Watch a familiar comfort film together',
                        'Provide a gentle massage',
                        'Make tea or a warm beverage'
                    ]
                },
                date: {
                    title: 'Date Ideas',
                    items: [
                        'Quiet movie night at home',
                        'Picnic in a calm setting',
                        'Cook a meal together',
                        'Stargazing',
                        'At-home spa activities',
                        'Scenic drive'
                    ]
                },
                gift: {
                    title: 'Thoughtful Gifts',
                    items: [
                        'Her favorite treats',
                        'Soft blanket or socks',
                        'Handwritten note',
                        'Fresh flowers',
                        'A curated playlist',
                        'An open favor coupon'
                    ]
                }
            };

            const suggestion = suggestions[type];
            const itemsHtml = suggestion.items.map(item => `
                <li style="padding: 8px 0; color: var(--text-secondary); border-bottom: 1px solid var(--border-subtle);">
                    ${item}
                </li>
            `).join('');

            window.MoodSyncApp.showModal(`
                <ul style="list-style: none; padding: 0; margin: 0;">
                    ${itemsHtml}
                </ul>
            `, { title: suggestion.title });
        }

        async function enableNotifications() {
            const statusEl = document.getElementById('notification-status');
            const enableBtn = document.getElementById('enable-notifications-btn');
            const testBtn = document.getElementById('test-notification-btn');

            statusEl.textContent = 'Requesting permission...';

            try {
                const granted = await window.DesktopNotifications.requestPermission();

                if (granted) {
                    statusEl.textContent = 'Enabled - Daily updates active';
                    enableBtn.style.display = 'none';
                    testBtn.style.display = 'inline-flex';
                    window.DesktopNotifications.startDailyCheck();
                } else {
                    statusEl.textContent = 'Permission denied - Enable in browser settings';
                }
            } catch (error) {
                statusEl.textContent = 'Error: ' + error.message;
            }
        }

        function testNotification() {
            const user = window.MoodSyncStorage.getUserProfile();

            if (user && user.lastPeriodDate) {
                const cycleInfo = window.MoodSyncCycle.getCycleInfo(user.lastPeriodDate, user.cycleLength);
                window.DesktopNotifications.sendPartnerNotification(cycleInfo);
            } else {
                window.DesktopNotifications.sendTestNotification();
            }
        }

        function checkNotificationStatus() {
            if (window.DesktopNotifications && window.DesktopNotifications.permission === 'granted') {
                const statusEl = document.getElementById('notification-status');
                const enableBtn = document.getElementById('enable-notifications-btn');
                const testBtn = document.getElementById('test-notification-btn');

                if (statusEl && enableBtn && testBtn) {
                    statusEl.textContent = 'Enabled - Daily updates active';
                    enableBtn.style.display = 'none';
                    testBtn.style.display = 'inline-flex';
                    window.DesktopNotifications.startDailyCheck();
                }
            }
        }

        setTimeout(checkNotificationStatus, 500);
    </script>
</body>

</html>